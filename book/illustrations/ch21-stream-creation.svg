<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 750 550" width="750" height="550">
  <defs>
    <linearGradient id="clientBox" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#00ADD8;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#0095BD;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="serverBox" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#9B59B6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#8E44AD;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-5%" y="-5%" width="110%" height="115%">
      <feDropShadow dx="1" dy="2" stdDeviation="2" flood-opacity="0.15"/>
    </filter>
    <marker id="arrowReq" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#27AE60"/>
    </marker>
    <marker id="arrowResp" markerWidth="10" markerHeight="7" refX="1" refY="3.5" orient="auto">
      <polygon points="10 0, 0 3.5, 10 7" fill="#3498DB"/>
    </marker>
    <marker id="arrowAsync" markerWidth="10" markerHeight="7" refX="1" refY="3.5" orient="auto">
      <polygon points="10 0, 0 3.5, 10 7" fill="#F0AD4E"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="750" height="550" fill="#FAFAFA"/>

  <!-- Title -->
  <text x="375" y="30" font-family="Arial, sans-serif" font-size="20" font-weight="bold" text-anchor="middle" fill="#333">CREATE_PLAYBACK_STREAM with Async Notifications</text>

  <!-- Client Header -->
  <g transform="translate(100, 50)" filter="url(#shadow)">
    <rect x="0" y="0" width="120" height="40" rx="6" fill="url(#clientBox)"/>
    <text x="60" y="25" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">Go Client</text>
  </g>

  <!-- Server Header -->
  <g transform="translate(530, 50)" filter="url(#shadow)">
    <rect x="0" y="0" width="120" height="40" rx="6" fill="url(#serverBox)"/>
    <text x="60" y="25" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">PA Server</text>
  </g>

  <!-- Timeline lines -->
  <line x1="160" y1="90" x2="160" y2="510" stroke="#00ADD8" stroke-width="3"/>
  <line x1="590" y1="90" x2="590" y2="510" stroke="#9B59B6" stroke-width="3"/>

  <!-- Step 1: CREATE_PLAYBACK_STREAM -->
  <g transform="translate(0, 115)">
    <circle cx="160" cy="0" r="8" fill="#00ADD8"/>
    <text x="10" y="5" font-family="Arial, sans-serif" font-size="10" fill="#666">1. CREATE_PLAYBACK</text>
    <text x="10" y="17" font-family="Arial, sans-serif" font-size="10" fill="#666">   _STREAM (cmd=3)</text>

    <line x1="168" y1="0" x2="582" y2="0" stroke="#27AE60" stroke-width="2" marker-end="url(#arrowReq)"/>

    <!-- Message content box -->
    <rect x="240" y="8" width="270" height="55" rx="4" fill="#E8F8F5" stroke="#27AE60"/>
    <text x="250" y="25" font-family="Consolas, monospace" font-size="9" fill="#1E8449">sample_spec: S16LE, 1ch, 44100Hz</text>
    <text x="250" y="38" font-family="Consolas, monospace" font-size="9" fill="#1E8449">channel_map, buffer_attrs</text>
    <text x="250" y="51" font-family="Consolas, monospace" font-size="9" fill="#1E8449">sink=0xFFFFFFFF, volume=0x10000</text>
  </g>

  <!-- Step 2: STARTED (async) -->
  <g transform="translate(0, 210)">
    <circle cx="590" cy="0" r="6" fill="#F0AD4E"/>
    <text x="605" y="5" font-family="Arial, sans-serif" font-size="10" fill="#F0AD4E">async</text>

    <line x1="582" y1="0" x2="168" y2="0" stroke="#F0AD4E" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowAsync)"/>
    <text x="375" y="-8" font-family="Consolas, monospace" font-size="10" text-anchor="middle" fill="#F0AD4E">STARTED (cmd=86)</text>

    <!-- Skip label -->
    <text x="135" y="-3" font-family="Arial, sans-serif" font-size="9" text-anchor="end" fill="#F0AD4E">skip</text>
  </g>

  <!-- Step 3: REQUEST (async) -->
  <g transform="translate(0, 255)">
    <circle cx="590" cy="0" r="6" fill="#F0AD4E"/>
    <text x="605" y="5" font-family="Arial, sans-serif" font-size="10" fill="#F0AD4E">async</text>

    <line x1="582" y1="0" x2="168" y2="0" stroke="#F0AD4E" stroke-width="2" stroke-dasharray="6,3" marker-end="url(#arrowAsync)"/>
    <text x="375" y="-8" font-family="Consolas, monospace" font-size="10" text-anchor="middle" fill="#F0AD4E">REQUEST (cmd=61)</text>

    <!-- Skip label -->
    <text x="135" y="-3" font-family="Arial, sans-serif" font-size="9" text-anchor="end" fill="#F0AD4E">skip</text>
  </g>

  <!-- Step 4: REPLY (the one we want) -->
  <g transform="translate(0, 320)">
    <circle cx="590" cy="0" r="8" fill="#9B59B6"/>
    <text x="605" y="5" font-family="Arial, sans-serif" font-size="11" fill="#666">REPLY</text>

    <line x1="582" y1="0" x2="168" y2="0" stroke="#3498DB" stroke-width="3" marker-end="url(#arrowResp)"/>

    <!-- Response content box -->
    <rect x="240" y="8" width="270" height="42" rx="4" fill="#EBF5FB" stroke="#3498DB"/>
    <text x="250" y="25" font-family="Consolas, monospace" font-size="9" fill="#2471A3">stream_index (channel ID for data)</text>
    <text x="250" y="40" font-family="Consolas, monospace" font-size="9" fill="#2471A3">sink_input_index, buffer attrs...</text>
  </g>

  <!-- DrainReplies box -->
  <g transform="translate(30, 400)">
    <rect x="0" y="0" width="690" height="55" rx="6" fill="#FEF9E7" stroke="#F39C12" filter="url(#shadow)"/>
    <text x="345" y="22" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#7D6608">DrainReplies() Loop</text>
    <text x="345" y="42" font-family="Consolas, monospace" font-size="10" text-anchor="middle" fill="#7D6608">Read frame → if cmd == 86 or 61: skip → if cmd == 2 (REPLY): return → if cmd == 0 (ERROR): fail</text>
  </g>

  <!-- Bottom note -->
  <g transform="translate(30, 475)">
    <rect x="0" y="0" width="690" height="30" rx="4" fill="#FDEDEC" stroke="#E74C3C"/>
    <text x="345" y="20" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#922B21">Server interleaves async notifications — must skip until REPLY(2) or ERROR(0)</text>
  </g>
</svg>
